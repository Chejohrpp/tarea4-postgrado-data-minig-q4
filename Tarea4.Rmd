---
title: "Tarea 4"
output: html_notebook
author: "Sergio Rolando Hernandez Perez 999017213"
---

```{r}
install.packages("arules", type="binary")
library("arules")
install.packages("ggplot2")
library("ggplot2")
install.packages("readxl")
library("readxl")
```

```{r}
data <- read_excel("base-de-datos-violencia-intrafamiliar-ano-2024_v3.xlsx")
data_use <- data[, c("HEC_TIPAGRE","QUIEN_REPORTA", "VIC_EDAD","VIC_SEXO","TOTAL_HIJOS","VIC_OCUP","VIC_DISC")]
data.frame(1:ncol(data_use), colnames(data_use))
```

```{r}
data_use[is.na(data_use)] <- -1
cluster <- kmeans(data_use, centers = 3)
```

```{r}
##Total de hijos
data_child <- subset(data_use, TOTAL_HIJOS!=99)
cluster_without_99_child <- kmeans(data_child, centers = 7)
ggplot(data_child, aes(x = VIC_OCUP, y = TOTAL_HIJOS, color =as.factor(cluster_without_99_child$cluster)))+
  geom_point()+
  geom_point(data = as.data.frame(cluster_without_99_child$centers), aes(x = VIC_OCUP, y = TOTAL_HIJOS), color="black", size=4, shape=17)+
  labs(title = "") +
  theme_bw()
```

#Installing a better visualization plot

```{r}
install.packages("remotes")  # if not installed yet
remotes::install_github("hrbrmstr/ggalt")
library(ggalt)
```


```{r}
ggplot(data_child, aes(x = VIC_OCUP, y = TOTAL_HIJOS, color = as.factor(cluster_without_99_child$cluster), shape = as.factor(cluster_without_99_child$cluster))) +
  geom_point(size = 3, alpha = 0.7) +                                   
  geom_point(data = as.data.frame(cluster_without_99_child$centers),                    
             aes(x = VIC_OCUP, y = TOTAL_HIJOS), color = "black", fill = "gray", size = 5, shape = 21) +
  geom_encircle(aes(group = cluster_without_99_child$cluster, fill = as.factor(cluster_without_99_child$cluster)), 
                alpha = 0.2, s_shape = 1, expand = 0.05) +              
  scale_color_manual(values = c("pink", "brown", "green","skyblue","blue", "violet","salmon")) +
  scale_shape_manual(values = c(16, 17, 15, 18,19,20,21,22)) +                   
  labs(title = "ocupacion victima vs total_hijos", x = "ocupacion de la victima", y = "total hijos") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right",
    legend.title = element_blank()
  )
```
```{r}
data_use_agr <- data[, c("HEC_TIPAGRE","QUIEN_REPORTA", "AGR_EDAD","AGR_SEXO","TOTAL_HIJOS","AGR_OCUP")]
data.frame(1:ncol(data_use_agr), colnames(data_use_agr))
```

```{r}
data_use_agr[is.na(data_use_agr)] <- -1
cluster_agr <- kmeans(data_use_agr, centers = 3)
```

```{r}
##Total de hijos
data_child_agr <- subset(data_use_agr, TOTAL_HIJOS!=99)
cluster_without_99_child_agr <- kmeans(data_child_agr, centers = 6)
ggplot(data_child_agr, aes(x = AGR_OCUP, y = TOTAL_HIJOS, color =as.factor(cluster_without_99_child_agr$cluster)))+
  geom_point()+
  geom_point(data = as.data.frame(cluster_without_99_child_agr$centers), aes(x = AGR_OCUP, y = TOTAL_HIJOS), color="black", size=4, shape=17)+
  labs(title = "") +
  theme_bw()
```
```{r}
ggplot(data_child_agr, aes(x = AGR_OCUP, y = TOTAL_HIJOS, color = as.factor(cluster_without_99_child_agr$cluster), shape = as.factor(cluster_without_99_child_agr$cluster))) +
  geom_point(size = 3, alpha = 0.7) +                                   
  geom_point(data = as.data.frame(cluster_without_99_child_agr$centers),                    
             aes(x = AGR_OCUP, y = TOTAL_HIJOS), color = "black", fill = "black", size = 5, shape = 21) +
  geom_encircle(aes(group = cluster_without_99_child_agr$cluster, fill = as.factor(cluster_without_99_child_agr$cluster)), 
                alpha = 0.2, s_shape = 1, expand = 0.05) +              
  scale_color_manual(values = c("pink", "brown","skyblue","blue", "#BFD641","salmon")) +
  scale_shape_manual(values = c(16, 17, 15, 18,19,20,21)) +                   
  labs(title = "ocupacion agresor vs total_hijos", x = "ocupacion del agresor", y = "total hijos") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right",
    legend.title = element_blank()
  )
```
```{r}
data_use_3d <- data[, c("HEC_TIPAGRE","QUIEN_REPORTA", "VIC_EDAD","VIC_SEXO","TOTAL_HIJOS","VIC_OCUP","VIC_DISC","VIC_ESCOLARIDAD")]
data.frame(1:ncol(data_use_3d), colnames(data_use_3d))
```

```{r}
data_use_3d[is.na(data_use_3d)] <- -1
data_child_3d <- subset(data_use_3d, TOTAL_HIJOS!=99)
data_child_3d <- subset(data_use_3d, VIC_ESCOLARIDAD!=99)
cluster_without_99_child_3d <- kmeans(data_child_3d, centers = 5)
```

```{r}
ggplot(data_child_3d, aes(x = VIC_OCUP, y = VIC_ESCOLARIDAD, color =as.factor(cluster_without_99_child_3d$cluster)))+
  geom_point()+
  geom_point(data = as.data.frame(cluster_without_99_child_3d$centers), aes(x = VIC_OCUP, y = VIC_ESCOLARIDAD), color="black", size=4, shape=17)+
  labs(title = "") +
  theme_bw()
```
```{r}
data_use_agr_3d <- data[, c("HEC_TIPAGRE","QUIEN_REPORTA", "AGR_EDAD","AGR_SEXO","TOTAL_HIJOS","AGR_OCUP","AGR_ESCOLARIDAD")]
data.frame(1:ncol(data_use_agr_3d), colnames(data_use_agr_3d))
```


```{r}
data_use_agr_3d[is.na(data_use_agr_3d)] <- -1
data_child_3d_agr <- subset(data_use_agr_3d, TOTAL_HIJOS!=99)
data_child_3d_agr <- subset(data_use_agr_3d, AGR_ESCOLARIDAD!=99)
cluster_without_99_child_3d_agr <- kmeans(data_child_3d_agr, centers = 5)
```

```{r}
ggplot(data_child_3d_agr, aes(x = AGR_OCUP, y = AGR_ESCOLARIDAD, color =as.factor(cluster_without_99_child_3d_agr$cluster)))+
  geom_point()+
  geom_point(data = as.data.frame(cluster_without_99_child_3d_agr$centers), aes(x = AGR_OCUP, y = AGR_ESCOLARIDAD), color="black", size=4, shape=17)+
  labs(title = "") +
  theme_bw()
```

```{r}
## --- Datos y colores
x <- data_child_3d_agr$AGR_OCUP
y <- data_child_3d_agr$AGR_ESCOLARIDAD
z <- data_child_3d_agr$TOTAL_HIJOS
cl <- factor(cluster_without_99_child_3d_agr$cluster)
pal <- c("#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b",
         "#e377c2","#7f7f7f","#bcbd22","#17becf")[as.integer(cl)]

## --- Matriz de proyección (elige ángulo de vista)
theta <- 40   # rotación horizontal (0–360)
phi   <- 20   # elevación (0–90)

## Trucos: creamos una “superficie plana” solo para obtener pmat
pmat <- persp(x = range(x), y = range(y),
              z = matrix(0, nrow = 2, ncol = 2),
              zlim = range(z),
              theta = theta, phi = phi,
              xlab = "Ocupación (CIUO)",
              ylab = "Escolaridad (códigos)",
              zlab = "Total de hijos",
              ticktype = "detailed",
              col = NA, border = NA)
## --- Puntos 3D proyectados
xy <- trans3d(x, y, z, pmat = pmat)
points(xy, col = pal, pch = 16, cex = 0.8)

## --- Centroides del kmeans
cent <- as.data.frame(cluster_without_99_child_3d_agr$centers)
cxy  <- trans3d(cent$AGR_OCUP, cent$AGR_ESCOLARIDAD, cent$TOTAL_HIJOS, pmat = pmat)
points(cxy, pch = 4, cex = 1.6, lwd = 2)  # X negras para centroids
title(main = "K-means 3D (AGR_OCUP × AGR_ESCOLARIDAD × TOTAL_HIJOS)")

```

```{r}
pairs(data_child_3d_agr[, c("AGR_OCUP","AGR_ESCOLARIDAD","TOTAL_HIJOS")],
      col = pal, pch = 16, main = "Proyecciones 2D por clúster")

```

